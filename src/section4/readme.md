# 스레드 성능 최적화
## CPU와 코어
- CPU는 Central Processing Unit의 약자로 컴퓨터의 두뇌이다.
- 실제로 계산하고 명령을 실행한다.
- CPU 코어는 예전에는 1개였지만 요즘에는 멀티코어가 기본이다.
  - 4 코어 CPU라고 하면 일을 동시에 4개 처리할 수 있다는 뜻이다.

## 물리 코어 vs 가상 코어
- 물리 코어는 실제 하드웨어로 된 코어를 뜻한다.
- 가상 코어는 논리 코어라고도 하며 하나의 물리 코어로 작업을 분산처리할 수 있다.
- 예를 들어, 하나의 물리 코어가 멀티 코어(2 개)를 지원하는 경우
  - 8코어 CPU라고 하면 16 스레드를 실행할 수 있다고 이해할 수 있다.

## 스레드란?
- 하나의 작업 흐름을 뜻한다.
- 하나의 프로세스(프로그램) 안에서 동시에 여러 일을 할 때 분산 단위로 스레드가 필요하다.
  - 음악 앱에서 음악을 들으며, 최신 댓글을 불러옴과 동시에, 댓글을 작성하는 등

## 스레드와 CPU 코어의 관계
- 1 개의 코어에는 1개의 스레드만 실행이 가능하다.
- 코어보다 스레드가 많을 경우 CPU가 순서를 빠르게 바꿔가며 실행시킨다.
  - 이를 컨텍스트 스위칭(Context Switching)이라고 한다.
- 64 개의 가상 코어는 동시에 64 개의 스레드를 실행 가능하다.
  - 위의 예시에서 200 개의 스레드가 있는 경우, 64 개는 실행되며 136 개는 대기이다.

## 블로킹과 논 블로킹의 차이
- 블로킹(Blocking)
  - 스레드가 기다리는 동안 아무것도 못한다.
    - 예) DB 응답 대기 시, 해당 CPU 코어는 스레드가 할당된 채로 놀고 있게 된다.
- 논 블로킹(Non-Blocking)
  - 기다려야 할 작업은 스레드가 빠지고, 나중에 완료되면 다시 작업한다.
    - 예) DB 응답 대기 시, 해당 CPU 코어는 다른 스레드의 요청을 처리하며 놀지 않는다.

## 종합 정리
- 블로킹 구조에서는 스레드가 DB 요청과 같은 응답 시간이 긴 경우 코어는 놀고 있는데 스레드는 일을 못하는 상태가 된다.
- 따라서 요청이 지속적으로 생기는 경우 이를 처리하기 위해서는 대기에 필요한 스레드를 많이 만들어야 한다.
  - CPU 코어 수보다 훨씬 많은 스레드를 필요로 한다.
  - 만약 여유 스레드 수를 넘어 요청이 들어오면 작업 큐에 대기하게 된다.
  - 이마저 넘어버리면 요청이 거부되거나 버려지게 된다.
- 논 블로킹 구조에서는 요청 처리중 I/O 작업이 있으면 해당 작업을 넘기고 다른 스레드를 할당하여 처리한다.
- 따라서 스레드를 적게 사용해도 많은 요청을 처리할 수 있다.
  - 보통 CPU 코어 수만큼 있으면 충분하다.

## 기타 용어
### Latency(지연 시간)
- 요청 하나가 들어와서 응답을 받기까지 걸리는 시간

### Throughput(처리량)
- 일청 시간 동안 처리할 수 있는 요청으 ㅣ개수
