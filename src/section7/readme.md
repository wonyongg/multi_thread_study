# 원자적 연산
## 원자적 연산이란?
```java
Object a = new Object();
```
- 프로그래밍에서 어떤 연산이 수행되는 도중에 중간에 끼어들 수 없고, 오직 완전하 끝나거나 안하거나 둘 중 하나인 상태를 의미한다.
- 즉, 한 번의 동작으로 끝나는 연산이며, 중간값이 존재하지 않는다.
  - 따라서 다른 스레드의 개입으로 인해 중간 연산 결과에 문제가 생길 수 없다. 
    - 아무 문제없이 온전히 끝나거나 아니거나 둘 중 하나이다.
  - 반대로 여러 단계로 나뉘어져 다른 스레드의 영향을 받는 연산을 원자적이지 않다고 말한다.  
- 모든 참조값(주소) 할당은 원자적 연산이다.
  - `Object a = new Object();`
    - 메모리에 객체를 생성하고 그 객체의 주소값을 생성하여 변수에 할당한다.
    - 참조값 할당은 참조값(주소)을 변수 `a`에 할당하는 것뿐이므로 원자적이다.
- `long`, `double`을 제외한 나머지 기본 타입은 원자적 연산에 해당한다.
  - 자바에서 JVM은 32 비트 이하 크기인 타입 경우 원자적으로 처리할 수 있다.
  - 그러나,`long`, `double`의 크기는 64 비트이기 때문에 2 번 나눠서 처리해야 한다.
  - 따라서 복수의 CPU 명령어가 필요하며 그 사이에 다른 스레드가 끼어들 가능성이 생긴다.

## `volatile`
- 이를 해결하기 위해 자바에서는 `volatile` 키워드를 제공한다.
  - 이 키워드를 사용하면 해당 변수의 메인 메모리에서 최신값을 읽고 쓰게 하도록 강제한다.
  - 자바는 성능을 위해 변수 값을 cpu 캐시에 저장해두는 경우가 있다.
  - 스레드 A가 변수 `x`를 10으로 바꿔도, 스레드 B에서는 캐시값을 읽어 이전 `x` 값을 보고 있을 수 있다.
  - `volatile`을 사용하면 항상 메인 메모리에서 최신값을 읽기 때문에 스레드 간 가시성이 보장된다.